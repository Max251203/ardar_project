{% extends "base.html" %}
{% load static %}
{% block title %}{{ room.name }} — Трансляция{% endblock %}
{% block content %}

<div class="livestream-grid">

  <!-- === ОСНОВНАЯ СЕКЦИЯ (ГОВОРЯЩИЙ + УЧАСТНИКИ) === -->
  <section class="area-main-combined">
    <div class="main-section-header">
      <h2 class="area-header">Трансляция</h2>
    </div>
    
    <div class="main-section-content">
      <!-- Главная карточка -->
      <div class="main-speaker-wrapper">
        <h3 class="sub-header">Сейчас говорит</h3>
        <div id="main-speaker-container">
          <div class="no-speaker">Нет активного говорящего</div>
        </div>
        <!-- Скрываем статус-бар -->
        <div id="speaker-status" class="speaker-bar" style="display: none;"></div>
      </div>
      
      <!-- Участники -->
      <div class="participants-container">
        <h3 class="sub-header">Участники</h3>
        <div class="participants-scroll" id="secondary-participants"></div>
      </div>
    </div>
    
    <!-- Панель управления -->
    <div class="control-panel">
      <button id="mic-btn" class="control-btn" title="Микрофон">
        <img src="{% static 'img/mic-on.png' %}" class="icon-btn" id="mic-icon" alt="Микрофон">
      </button>
      <button id="cam-btn" class="control-btn" title="Камера">
        <img src="{% static 'img/cam-on.png' %}" class="icon-btn" id="cam-icon" alt="Камера">
      </button>
      <button id="hand-btn" class="control-btn" title="Поднять руку">
        <img src="{% static 'img/hand.png' %}" class="icon-btn" alt="Поднять руку">
      </button>

      <!-- Кнопка забрать/вернуть слово -->
      <button id="word-toggle-btn" class="control-btn" title="Управление словом" style="display:none;">
        <img src="{% static 'img/word_back.png' %}" class="icon-btn" alt="Слово">
      </button>

      <button id="leave-btn" class="control-btn" title="Покинуть трансляцию">
        <img src="{% static 'img/exit.png' %}" class="icon-btn" alt="Выйти">
      </button>

      {% if is_host or user.role == 'admin' or user.is_superuser %}
        <a href="{% url 'end_livestream' room.id %}" class="control-btn end-btn" title="Завершить">
          <img src="{% static 'img/end.png' %}" class="icon-btn" alt="Завершить">
        </a>
      {% endif %}
    </div>
  </section>

  <!-- === ПАНЕЛЬ: Участники / Чат === -->
  <section class="area-panel">
    <div class="tabs-header">
      <button class="tab-button active" onclick="switchPanelTab('participants')">Участники</button>
      <button class="tab-button" onclick="switchPanelTab('chat')">Чат</button>
    </div>

    <div id="panel-participants" class="tab-content active">
      <input type="text" id="user-search" placeholder="Поиск...">
      <div class="users-list" id="participants-panel"></div>
    </div>

    <div id="panel-chat" class="tab-content">
      <div id="chat-log" class="chat-messages"></div>
      <form id="chat-form" class="chat-form">
        {% csrf_token %}
        <input type="text" id="chat-input" placeholder="Сообщение..." autocomplete="off">
        <button type="submit" class="send-btn">
          <img src="{% static 'img/send.png' %}" alt="▶" width="20">
        </button>
      </form>
    </div>
  </section>

</div>

<!-- === ALERT === -->
<div id="custom-alert" class="custom-alert" style="display: none;"></div>

<!-- === ДИАЛОГ РУКИ === -->
<div id="hand-raised-dialog" class="dialog-modal" style="display: none;">
  <div class="dialog-content">
    <h3>Запрос слова</h3>
    <p id="hand-raised-user">Имя пользователя</p>
    <div class="dialog-actions">
      <button id="give-word-btn" class="btn-approve">Дать слово</button>
      <button id="reject-hand-btn" class="btn-reject">Отклонить</button>
    </div>
  </div>
</div>

<!-- === JS CONFIG === -->
<script>
window.livestreamAppId = "{{ app_id }}";
window.livestreamChannel = "{{ channel_id }}";
window.livestreamUserId = "{{ user_id|default:user.id }}";
window.livestreamUserName = "{{ user_name|default:user.name }}";
window.livestreamIsHost = {{ is_host|yesno:"true,false" }};
window.livestreamRoomId = "{{ room.id }}";
window.livestreamCsrfToken = "{{ csrf_token }}";
window.livestreamUserRole = "{{ user.role }}";
window.livestreamIsSuperuser = {{ user.is_superuser|yesno:"true,false" }};
</script>

<!-- === SDK & Logic === -->
<script src="{% static 'lib/agora/AgoraRTC_N.js' %}"></script>
<script src="{% static 'lib/agora/AgoraRTM.min.js' %}"></script>
<script src="{% static 'js/livestream_rtm_full.js' %}"></script>

<!-- Вкладки -->
<script>
function switchPanelTab(tab) {
  document.querySelectorAll(".tab-content").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
  document.getElementById("panel-" + tab).classList.add("active");
  document.querySelector(`[onclick*="${tab}"]`).classList.add("active");
}
</script>

<!-- Стили -->
<link rel="stylesheet" href="{% static 'css/livestream.css' %}">

<style>
:root{--primary:#2563eb;--accent:#10b981;--danger:#ef4444;--warning:#f59e0b;--bg:#f3f4f6;--card:#ffffff;--text:#111827;--text-light:#6b7280;--border:#e5e7eb;--radius:8px;--transition:0.2s ease;}[data-theme="dark"]{--primary:#3b82f6;--accent:#22c55e;--danger:#ef4444;--warning:#facc15;--bg:#111827;--card:#1f2937;--text:#f3f4f6;--text-light:#d1d5db;--border:#374151;}.livestream-grid{display:grid;grid-template-columns:3fr 1fr;height:calc(100vh - 80px);gap:15px;padding:10px;background-color:var(--bg);overflow:hidden;width:100%;max-width:100%;margin:0;box-sizing:border-box;}.container{max-width:100% !important;padding:0 !important;margin:0 !important;width:100% !important;}.area-header{font-size:16px;font-weight:bold;margin-bottom:10px;color:var(--primary);}.sub-header{font-size:14px;font-weight:bold;margin-bottom:8px;color:var(--primary);}.area-main-combined,.area-panel{background:var(--card);border-radius:var(--radius);padding:15px;display:flex;flex-direction:column;height:100%;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.05);box-sizing:border-box;}.main-section-content{display:flex;flex:1;gap:15px;overflow:hidden;}.main-speaker-wrapper{flex:2;display:flex;flex-direction:column;overflow:hidden;min-height:300px;}#main-speaker-container{flex:1;background-color:#000;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;position:relative;display:flex;justify-content:center;align-items:center;min-height:250px;}.participants-container{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:200px;max-width:300px;height:100%;border:1px solid var(--border);border-radius:var(--radius);padding:10px;background-color:rgba(0,0,0,0.02);box-sizing:border-box;min-height:300px;}.participants-scroll{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding-right:5px;min-height:250px;}.no-speaker{color:var(--text-light);font-size:14px;padding:20px;}.speaker-bar{font-size:14px;color:var(--text-light);margin-top:10px;text-align:center;font-weight:bold;}.control-panel{display:flex;justify-content:center;gap:10px;margin-top:15px;flex-wrap:wrap;}.control-btn{width:45px;height:45px;border-radius:50%;background-color:var(--bg);border:1px solid var(--border);display:inline-flex;justify-content:center;align-items:center;cursor:pointer;transition:var(--transition);}.control-btn:hover{background-color:var(--primary);}.control-btn:hover .icon-btn{filter:brightness(5);}.control-btn.disabled{opacity:0.5;cursor:not-allowed;}.end-btn{background-color:var(--danger);}.end-btn:hover{background-color:#dc2626;}.icon-btn{width:22px;height:22px;transition:var(--transition);}.user-card{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;gap:8px;box-shadow:0 1px 3px rgba(0,0,0,0.05);margin-bottom:10px;}.user-card .video-slot{height:130px;background-color:#111;border-radius:6px;overflow:hidden;display:flex;justify-content:center;align-items:center;color:var(--text-light);}.video-info{display:flex;justify-content:space-between;align-items:center;}.video-name{font-size:14px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70%;}.video-icons{display:flex;gap:6px;}.status-icon{width:16px;height:16px;}.tabs-header{display:flex;border-bottom:1px solid var(--border);margin-bottom:10px;}.tab-button{flex:1;padding:10px;border:none;background:none;font-weight:600;color:var(--text-light);cursor:pointer;border-bottom:2px solid transparent;transition:var(--transition);}.tab-button.active{color:var(--primary);border-bottom-color:var(--primary);}.tab-content{flex:1;display:none;flex-direction:column;gap:10px;height:100%;overflow:hidden;}.tab-content.active{display:flex;}#user-search{padding:8px 12px;border:1px solid var(--border);background:var(--bg);border-radius:6px;color:var(--text);}.users-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:10px;padding-right:10px;}.user-row{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:8px;font-size:13px;display:flex;justify-content:space-between;align-items:center;width:100%;box-sizing:border-box;}.user-row.speaking{background-color:rgba(37,99,235,0.1);border-color:var(--primary);}.user-actions{display:flex;gap:4px;flex-wrap:wrap;}.action-btn{width:28px;height:28px;border:none;background:var(--card);cursor:pointer;border-radius:4px;display:flex;justify-content:center;align-items:center;transition:var(--transition);}.action-btn:hover{background:var(--primary);}.action-btn:hover .action-icon{filter:brightness(5);}.action-btn.allow{background-color:rgba(16,185,129,0.1);border:1px solid var(--accent);}.action-btn.deny{background-color:rgba(239,68,68,0.1);border:1px solid var(--danger);}.action-icon{width:18px;height:18px;transition:var(--transition);}.chat-messages{flex:1;overflow-y:auto;background:var(--bg);border-radius:var(--radius);border:1px solid var(--border);padding:10px;font-size:14px;}.chat-message{margin-bottom:10px;background:var(--card);padding:8px 12px;border-radius:var(--radius);border:1px solid var(--border);}.chat-time{font-size:11px;color:var(--text-light);margin-left:8px;}.chat-form{display:flex;gap:10px;}.chat-form input{flex:1;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius);background:var(--bg);color:var(--text);}.send-btn{min-width:40px;background:var(--primary);color:white;border:none;border-radius:var(--radius);display:flex;justify-content:center;align-items:center;cursor:pointer;transition:var(--transition);}.send-btn:hover{opacity:0.9;}.custom-alert{position:fixed;top:30px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:12px 20px;border-radius:var(--radius);box-shadow:0 4px 10px rgba(0,0,0,0.2);font-size:14px;z-index:9999;display:none;}.dialog-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:9999;}.dialog-content{background:var(--card);padding:25px;border-radius:8px;text-align:center;max-width:350px;box-shadow:0 10px 25px rgba(0,0,0,0.2);}.dialog-content h3{margin-bottom:15px;color:var(--primary);}.dialog-actions{display:flex;gap:10px;margin-top:20px;justify-content:center;}.btn-approve,.btn-reject{padding:10px 20px;font-weight:600;border:none;border-radius:6px;cursor:pointer;transition:var(--transition);}.btn-approve{background-color:var(--accent);color:white;}.btn-approve:hover{opacity:0.9;}.btn-reject{background-color:var(--danger);color:white;}.btn-reject:hover{opacity:0.9;}::-webkit-scrollbar{width:6px;height:6px;}::-webkit-scrollbar-track{background:rgba(0,0,0,0.05);border-radius:10px;}::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.2);border-radius:10px;}::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0.3);}@media (max-width:1200px){.livestream-grid{grid-template-columns:1fr;grid-template-rows:2fr 1fr;height:auto;min-height:calc(100vh - 80px);}.main-section-content{flex-direction:column;}.participants-container{max-width:100%;}}@media (max-width:768px){.livestream-grid{grid-template-columns:1fr;grid-template-rows:auto auto;height:auto;min-height:calc(100vh - 80px);padding:5px;}.area-main-combined{height:auto;min-height:400px;}.area-panel{height:350px;}.control-panel{flex-wrap:wrap;}}@media (max-width:480px){.livestream-grid{padding:5px;gap:10px;}.area-main-combined,.area-panel{padding:10px;}.control-btn{width:40px;height:40px;}.icon-btn{width:20px;height:20px;}.tab-button{font-size:14px;padding:8px;}}.waiting-screen{background-color:var(--card);border-radius:10px;padding:30px;text-align:center;max-width:600px;margin:50px auto;box-shadow:0 4px 12px rgba(0,0,0,0.1);}.waiting-screen h2{margin-top:0;color:var(--primary);margin-bottom:20px;}.waiting-screen p{margin-bottom:30px;font-size:16px;line-height:1.5;}.loader{display:inline-block;width:50px;height:50px;border:5px solid var(--border);border-radius:50%;border-top-color:var(--primary);animation:spin 1s linear infinite;}@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}.status-message{margin-top:20px;font-size:14px;color:var(--text-light);min-height:20px;}.btn-cancel{margin-top:20px;padding:10px 20px;background-color:#e5e7eb;color:#374151;border-radius:6px;font-weight:500;border:none;cursor:pointer;}.btn-cancel:hover{background-color:#d1d5db;}.main-speaker-card{width:100%;height:100%;}.main-speaker-card .video-slot{height:calc(100% - 40px);min-height:200px;}.video-placeholder{display:flex;justify-content:center;align-items:center;height:100%;color:var(--text-light);font-size:14px;}.speaking{background-color:rgba(37,99,235,0.1) !important;border-color:var(--primary) !important;font-weight:bold;}.action-btn.word-back{background-color:rgba(239,68,68,0.1);border:1px solid var(--danger);}.action-btn.give-word:hover,.action-btn.word-back:hover{background-color:var(--primary);}.action-btn.give-word:hover .action-icon,.action-btn.word-back:hover .action-icon{filter:brightness(5);}@keyframes fadeInOut{0%{opacity:0;transform:translate(-50%,-20px);}10%{opacity:1;transform:translate(-50%,0);}90%{opacity:1;transform:translate(-50%,0);}100%{opacity:0;transform:translate(-50%,-20px);}}main.container{max-width:100% !important;padding:0 !important;margin:0 !important;width:100% !important;overflow:hidden !important;}body:has(.livestream-grid) footer{display:none !important;}.user-name-row{max-width:65%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}.user-actions{flex-shrink:0;margin-left:5px;}
</style>
{% endblock %}