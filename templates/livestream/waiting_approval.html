{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="waiting-screen">
    <h2>Ожидание одобрения ведущего</h2>
    <p id="waiting-message">Ваша заявка на вход отправлена ведущему. Пожалуйста, дождитесь решения.</p>
    <div class="loader"></div>
    <div id="status-message" class="status-message"></div>
    <button id="cancel-waiting" class="btn-cancel">Отменить заявку</button>
</div>
<div id="custom-alert" class="custom-alert" style="display:none;"></div>
<style>
.waiting-screen {
    background-color: var(--card);
    border-radius: 10px;
    padding: 30px;
    text-align: center;
    max-width: 600px;
    margin: 50px auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.waiting-screen h2 {
    margin-top: 0;
    color: var(--primary);
    margin-bottom: 20px;
}
.waiting-screen p {
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.5;
}
.loader {
    display: inline-block;
    width: 50px;
    height: 50px;
    border: 5px solid var(--border);
    border-radius: 50%;
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.status-message {
    margin-top: 20px;
    font-size: 14px;
    color: var(--text-light);
    min-height: 20px;
}
.btn-cancel {
    margin-top: 20px;
    padding: 10px 20px;
    background-color: #e5e7eb;
    color: #374151;
    border-radius: 6px;
    font-weight: 500;
    border: none;
    cursor: pointer;
}
.custom-alert {
    position: fixed;
    top: 30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 15px 25px;
    border-radius: 8px;
    font-size: 16px;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    animation: fadeInOut 3.5s;
    max-width: 80%;
    text-align: center;
    display: none;
}
.custom-alert.info { background-color: #3b82f6; color: white; }
.custom-alert.success { background-color: #10b981; color: white; }
.custom-alert.warning { background-color: #f59e0b; color: white; }
.custom-alert.error { background-color: #ef4444; color: white; }
@keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -20px); }
    10% { opacity: 1; transform: translate(-50%, 0); }
    90% { opacity: 1; transform: translate(-50%, 0); }
    100% { opacity: 0; transform: translate(-50%, -20px); }
}
</style>
<script>
function showCustomAlert(msg, type = 'info') {
    let alertDiv = document.getElementById('custom-alert');
    alertDiv.innerHTML = msg;
    alertDiv.className = 'custom-alert ' + type;
    alertDiv.style.display = 'block';
    setTimeout(() => { alertDiv.style.display = 'none'; }, 3500);
}

let waitingActive = true;
function checkStatus() {
    if (!waitingActive) return;
    fetch("/livestream/check_status/{{ room.id }}/?t=" + Date.now())
        .then(response => response.json())
        .then(data => {
            if (!data.waiting_approval && !data.is_kicked && !data.room_ended) {
                document.getElementById('status-message').textContent = "Ваша заявка одобрена! Вход в трансляцию...";
                showCustomAlert("Ваша заявка одобрена! Вход в трансляцию...", "success");
                setTimeout(function() {
                    window.location.href = "/livestream/room/{{ room.id }}/";
                }, 1200);
            } else if (data.is_kicked && !data.waiting_approval) {
                document.getElementById('status-message').textContent = "Ваша заявка отклонена ведущим.";
                showCustomAlert("Ваша заявка отклонена ведущим.", "error");
                setTimeout(function() {
                    window.location.href = "{% url 'livestream_list' %}";
                }, 2000);
            } else if (data.room_ended) {
                document.getElementById('status-message').textContent = "Трансляция завершена. Перенаправление...";
                showCustomAlert("Трансляция завершена.", "warning");
                setTimeout(function() {
                    window.location.href = "{% url 'livestream_list' %}";
                }, 2000);
            } else {
                setTimeout(checkStatus, 2000);
            }
        })
        .catch(error => {
            setTimeout(checkStatus, 4000);
        });
}
checkStatus();

document.getElementById('cancel-waiting').onclick = function() {
    waitingActive = false;
    fetch("/livestream/cancel_waiting/{{ room.id }}/", {
        method: 'POST',
        headers: {'X-CSRFToken': '{{ csrf_token }}'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showCustomAlert("Вы отменили заявку на вход.", "info");
            setTimeout(function() {
                window.location.href = "{% url 'livestream_list' %}";
            }, 1200);
        }
    });
};
</script>
{% endblock %}